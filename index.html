<!DOCTYPE html>
<html lang="pt">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlador MIDI Avançado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        .midi-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #333;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4CAF50;
        }

        select, input, button {
            width: 100%;
            padding: 10px;
            border: 2px solid #555;
            border-radius: 5px;
            background: #444;
            color: #fff;
            font-size: 16px;
        }

        select:focus, input:focus, button:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .connect-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        .connect-btn:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        /* --- Estilos para Abas --- */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px;
            background: #333;
            border: none;
            color: #fff;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            background: #444;
        }

        .tab-button.active {
            background: #4CAF50;
            color: #fff;
            font-weight: bold;
            border-bottom: 2px solid #fff;
        }

        .tab-content {
            display: none; /* Esconde todas as abas por padrão */
            padding: 20px;
            background: #333;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        .tab-content.active {
            display: block; /* Mostra a aba ativa */
        }

        /* --- Estilos para Grelha de Botões (Notas) --- */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .midi-button {
            aspect-ratio: 1;
            border: 3px solid #555;
            border-radius: 10px;
            background: linear-gradient(135deg, #444, #666);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
        }

        .midi-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1));
            transition: opacity 0.3s;
        }

        .midi-button:hover::before {
            opacity: 0.8;
        }

        .midi-button:active,
        .midi-button.active {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #4CAF50;
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .midi-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            border-color: #444;
        }

        /* --- Estilos para Sliders CC (knobs/faders) --- */
        .cc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* 120px min width for each slider */
            gap: 20px;
            padding: 10px;
        }

        .cc-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #444;
            padding: 15px 10px;
            border-radius: 10px;
            border: 2px solid #555;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .cc-control label {
            font-size: 0.9em;
            margin-bottom: 10px;
            color: #4CAF50;
            text-align: center;
            font-weight: normal;
        }

        .cc-control input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #555;
            border-radius: 5px;
            outline: none;
            margin-bottom: 10px;
        }

        .cc-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .cc-control input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .cc-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background: #2a2a2a;
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 30px;
            text-align: center;
        }

        /* Desabilitar controles quando não conectados */
        .cc-control.disabled input[type="range"] {
            background: #666;
            cursor: not-allowed;
        }
        .cc-control.disabled input[type="range"]::-webkit-slider-thumb {
            background: #666;
            border-color: #555;
        }
        .cc-control.disabled input[type="range"]::-moz-range-thumb {
            background: #666;
            border-color: #555;
        }
        .cc-control.disabled .cc-value {
            color: #999;
        }

        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .note-display {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        .note-display h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .note-info {
            font-size: 18px;
            color: #fff;
        }

        /* --- Estilos para a Aba Híbrida --- */
        .hybrid-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .hybrid-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #444;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #555;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            min-height: 120px; /* Para manter a altura consistente */
            justify-content: space-around;
        }

        .hybrid-control label {
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #4CAF50;
        }

        .hybrid-control input[type="number"],
        .hybrid-control input[type="range"] {
            width: calc(100% - 10px); /* Ajuste para padding */
            margin-bottom: 5px;
        }

        .hybrid-control .midi-button {
            width: calc(100% - 10px);
            height: 50px; /* Ajuste para ter um botão de altura fixa */
            aspect-ratio: auto; /* Remove aspect ratio para que a altura funcione */
            font-size: 14px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Estilos específicos para o slider híbrido */
        .hybrid-control .hybrid-cc-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #555;
            border-radius: 5px;
            outline: none;
            margin-top: 5px;
        }

        .hybrid-control .hybrid-cc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        .hybrid-control .hybrid-cc-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 3px solid #333;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .hybrid-control .hybrid-cc-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #fff;
            background: #2a2a2a;
            padding: 3px 6px;
            border-radius: 3px;
            min-width: 20px;
            text-align: center;
            margin-top: 5px;
        }

        /* Desabilitar controles híbridos */
        .hybrid-control.disabled input,
        .hybrid-control.disabled button {
            background: #333 !important;
            color: #666 !important;
            cursor: not-allowed !important;
            border-color: #444 !important;
        }
        .hybrid-control.disabled .hybrid-cc-slider {
            background: #666 !important;
        }
        .hybrid-control.disabled .hybrid-cc-slider::-webkit-slider-thumb,
        .hybrid-control.disabled .hybrid-cc-slider::-moz-range-thumb {
             background: #666 !important;
             border-color: #555 !important;
        }
        .hybrid-control.disabled .hybrid-cc-value {
             color: #999 !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>🎹 Controlador MIDI Avançado</h1>

        <div class="midi-controls">
            <div class="control-group">
                <label for="websocketUrl">Endereço do Servidor MIDI (Ex: ws://192.168.1.100:8080):</label>
                <input type="text" id="websocketUrl" value="ws://192.168.137.1:8080" placeholder="ws://IP_DO_SEU_PC:PORTA">
            </div>
            <div class="settings">
                <div class="control-group">
                    <label for="midiChannel">Canal MIDI (1-16):</label>
                    <input type="number" id="midiChannel" min="1" max="16" value="1">
                </div>

                <div class="control-group" id="ccStartControlGroup">
                    <label for="ccStart">CC Inicial para Sliders (0-111):</label>
                    <input type="number" id="ccStart" min="0" max="111" value="0">
                </div>

                <div class="control-group" id="baseNoteControlGroup">
                    <label for="baseNote">Nota Base:</label>
                    <input type="number" id="baseNote" min="0" max="127" value="60" title="C4 = 60">
                </div>

                <div class="control-group" id="velocityControlGroup">
                    <label for="velocity">Velocidade:</label>
                    <input type="number" id="velocity" min="1" max="127" value="100">
                </div>
            </div>

            <button id="connectBtn" class="connect-btn">Conectar ao Servidor MIDI</button>
            <div id="status" class="status disconnected">Aguardando conexão...</div>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="notes">Notas (4x4)</button>
            <button class="tab-button" data-tab="ccs">Control Change (CC)</button>
            <button class="tab-button" data-tab="hybrid">Híbrida (8 CCs / 8 Notas)</button>
        </div>

        <div id="notesTab" class="tab-content active">
            <div class="button-grid" id="buttonGrid"></div>
        </div>

        <div id="ccsTab" class="tab-content">
            <div class="cc-grid" id="ccGrid"></div>
        </div>

        <div id="hybridTab" class="tab-content">
            <div class="hybrid-grid" id="hybridGrid"></div>
        </div>

        <div class="note-display">
            <h3>Última Mensagem Enviada</h3>
            <div id="lastMessageInfo" class="note-info">Nenhuma mensagem enviada ainda</div>
        </div>
    </div>
    <script>
        let ws = null; // Variável para a conexão WebSocket
        let activeButtons = new Set(); // Para notas (botões pressionados)

        // Nomes das notas
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        function getNoteNameFromMIDI(midiNote) {
            if (midiNote < 0 || midiNote > 127) return 'N/A';
            const octave = Math.floor(midiNote / 12) - 1;
            const noteName = noteNames[midiNote % 12];
            return `${noteName}${octave}`;
        }

        // Elementos DOM
        const connectBtn = document.getElementById('connectBtn');
        const websocketUrlInput = document.getElementById('websocketUrl');
        const midiChannelInput = document.getElementById('midiChannel');
        const baseNoteInput = document.getElementById('baseNote');
        const velocityInput = document.getElementById('velocity');
        const ccStartInput = document.getElementById('ccStart'); // Novo input para CC inicial
        const statusDiv = document.getElementById('status');
        const buttonGrid = document.getElementById('buttonGrid');     // Grelha para botões de notas (aba Notas)
        const ccGrid = document.getElementById('ccGrid');             // Grelha para sliders de CC (aba CCs)
        const hybridGrid = document.getElementById('hybridGrid');     // Grelha para controles híbridos (aba Híbrida)
        const lastMessageInfo = document.getElementById('lastMessageInfo');

        const notesTabContent = document.getElementById('notesTab');
        const ccsTabContent = document.getElementById('ccsTab');
        const hybridTabContent = document.getElementById('hybridTab');
        const tabButtons = document.querySelectorAll('.tab-button');

        // Controles que aparecem/desaparecem com a aba
        const baseNoteControlGroup = document.getElementById('baseNoteControlGroup');
        const velocityControlGroup = document.getElementById('velocityControlGroup');
        const ccStartControlGroup = document.getElementById('ccStartControlGroup'); // Novo

        let currentActiveTab = 'notes'; // Manter controlo da aba ativa


        // Função para conectar ao servidor WebSocket
        function connectWebSocket() {
            const url = websocketUrlInput.value;
            if (!url) {
                statusDiv.textContent = 'Erro: Insira o endereço do servidor MIDI.';
                statusDiv.className = 'status disconnected';
                return;
            }

            statusDiv.textContent = 'Conectando ao servidor MIDI...';
            statusDiv.className = 'status disconnected';
            connectBtn.disabled = true;

            ws = new WebSocket(url);

            ws.onopen = () => {
                console.log('Conectado ao servidor WebSocket.');
                statusDiv.textContent = 'Conectado ao servidor MIDI!';
                statusDiv.className = 'status connected';
                updateControlStates(); // Atualiza o estado dos controles com base na aba ativa
            };

            ws.onmessage = (event) => {
                console.log('Mensagem do servidor:', event.data);
                // Opcional: Processar feedback do servidor se necessário
            };

            ws.onclose = () => {
                console.log('Desconectado do servidor WebSocket.');
                statusDiv.textContent = 'Desconectado - Verifique o endereço e reconecte.';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disableAllControls(); // Desabilita todos os controles
            };

            ws.onerror = (error) => {
                console.error('Erro no WebSocket:', error);
                statusDiv.textContent = 'Erro de conexão: Verifique o endereço e se o servidor está ativo.';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disableAllControls(); // Desabilita todos os controles
            };
        }

        // --- Funções para Botões de Notas (Aba Notas) ---
        function enableButtons() {
            const buttons = buttonGrid.querySelectorAll('.midi-button');
            buttons.forEach(button => {
                button.disabled = false;
            });
        }

        function disableButtons() {
            const buttons = buttonGrid.querySelectorAll('.midi-button');
            buttons.forEach(button => {
                button.disabled = true;
            });
        }

        function createButtonGrid() {
            buttonGrid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const button = document.createElement('button');
                button.className = 'midi-button';
                button.textContent = i + 1;
                button.dataset.noteIndex = i;
                button.disabled = true; // Desabilitado por padrão até conectar

                // Eventos de mouse e toque para Note On/Off
                button.addEventListener('mousedown', (e) => { e.preventDefault(); handleButtonPress(i); });
                button.addEventListener('mouseup', (e) => { e.preventDefault(); handleButtonRelease(i); });
                button.addEventListener('mouseleave', (e) => { e.preventDefault(); handleButtonRelease(i); });
                button.addEventListener('touchstart', (e) => { e.preventDefault(); handleButtonPress(i); });
                button.addEventListener('touchend', (e) => { e.preventDefault(); handleButtonRelease(i); });
                button.addEventListener('touchcancel', (e) => { e.preventDefault(); handleButtonRelease(i); });

                buttonGrid.appendChild(button);
            }
        }

        function handleButtonPress(buttonIndex) {
            if (!ws || ws.readyState !== WebSocket.OPEN || activeButtons.has(buttonIndex)) return;

            activeButtons.add(buttonIndex);
            const button = buttonGrid.children[buttonIndex];
            if (button) button.classList.add('active'); // Garante que o botão existe antes de adicionar classe

            sendNoteOn(buttonIndex);
        }

        function handleButtonRelease(buttonIndex) {
            if (!ws || ws.readyState !== WebSocket.OPEN || !activeButtons.has(buttonIndex)) return;

            activeButtons.delete(buttonIndex);
            const button = buttonGrid.children[buttonIndex];
            if (button) button.classList.remove('active'); // Garante que o botão existe antes de remover classe

            sendNoteOff(buttonIndex);
        }

        function sendNoteOn(buttonIndex, noteOverride = null) { // Adicionado noteOverride
            const baseNote = parseInt(baseNoteInput.value);
            const channel = parseInt(midiChannelInput.value) - 1; // MIDI channels are 0-15
            const velocity = parseInt(velocityInput.value);
            const note = noteOverride !== null ? noteOverride : baseNote + buttonIndex;

            if (note < 0 || note > 127) return; // MIDI note limit

            const message = {
                type: 'noteOn',
                channel: channel,
                note: note,
                velocity: velocity
            };
            ws.send(JSON.stringify(message));

            const noteName = getNoteNameFromMIDI(note);
            lastMessageInfo.textContent = `Note ON: ${noteName} (${note}) - Velocidade: ${velocity} - Canal: ${channel + 1}`;
            console.log('Note ON (via WebSocket):', noteName, note, velocity, channel + 1);
        }

        function sendNoteOff(buttonIndex, noteOverride = null) { // Adicionado noteOverride
            const baseNote = parseInt(baseNoteInput.value);
            const channel = parseInt(midiChannelInput.value) - 1;
            const note = noteOverride !== null ? noteOverride : baseNote + buttonIndex;

            if (note < 0 || note > 127) return;

            const message = {
                type: 'noteOff',
                channel: channel,
                note: note
            };
            ws.send(JSON.stringify(message));

            const noteName = getNoteNameFromMIDI(note);
            lastMessageInfo.textContent = `Note OFF: ${noteName} (${note}) - Canal: ${channel + 1}`;
            console.log('Note OFF (via WebSocket):', noteName, note, channel + 1);
        }

        // --- Funções para Sliders CC (Aba CCs) ---
        function createCcSliders() {
            ccGrid.innerHTML = '';
            for (let i = 0; i < 16; i++) { // 16 sliders para CCs
                const ccControl = document.createElement('div');
                ccControl.className = 'cc-control disabled'; // Desabilitado por padrão
                ccControl.dataset.index = i; // Usaremos para calcular o CC real

                const label = document.createElement('label');
                label.textContent = `CC ${i}`; // Temporário, será atualizado
                ccControl.appendChild(label);

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = '0';
                slider.max = '127';
                slider.value = '0'; // Valor inicial
                slider.disabled = true; // Desabilitado por padrão
                slider.addEventListener('input', (e) => {
                    const currentCCNumber = parseInt(ccStartInput.value) + parseInt(ccControl.dataset.index);
                    sendControlChange(currentCCNumber, parseInt(e.target.value));
                    ccValueDisplay.textContent = e.target.value;
                });
                ccControl.appendChild(slider);

                const ccValueDisplay = document.createElement('span');
                ccValueDisplay.className = 'cc-value';
                ccValueDisplay.textContent = slider.value;
                ccControl.appendChild(ccValueDisplay);

                ccGrid.appendChild(ccControl);
            }
            updateCcSliderLabels(); // Atualiza os rótulos dos sliders
        }

        function updateCcSliderLabels() {
            const ccStart = parseInt(ccStartInput.value);
            const ccControls = ccGrid.querySelectorAll('.cc-control');
            ccControls.forEach(control => {
                const index = parseInt(control.dataset.index);
                const ccNumber = ccStart + index;
                control.querySelector('label').textContent = `CC ${ccNumber}`;
            });
        }

        function enableCcSliders() {
            const sliders = ccGrid.querySelectorAll('.cc-control');
            sliders.forEach(control => {
                control.classList.remove('disabled');
                control.querySelector('input[type="range"]').disabled = false;
            });
        }

        function disableCcSliders() {
            const sliders = ccGrid.querySelectorAll('.cc-control');
            sliders.forEach(control => {
                control.classList.add('disabled');
                control.querySelector('input[type="range"]').disabled = true;
            });
        }

        // Event listener para o input ccStartInput
        ccStartInput.addEventListener('input', updateCcSliderLabels);


        // --- Funções para Controles Híbridos (Aba Híbrida) ---
        function createHybridGrid() {
            hybridGrid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const hybridControl = document.createElement('div');
                hybridControl.className = 'hybrid-control disabled';
                hybridControl.dataset.index = i;

                if (i < 8) { // Primeiros 8: Knobs/Sliders de CC
                    hybridControl.innerHTML = `
                        <label for="hybridCc${i}">CC ${i}:</label>
                        <input type="number" id="hybridCc${i}" class="hybrid-cc-input" min="0" max="127" value="${i}" disabled>
                        <input type="range" class="hybrid-cc-slider" min="0" max="127" value="0" disabled>
                        <span class="hybrid-cc-value">0</span>
                    `;
                    const ccInput = hybridControl.querySelector(`#hybridCc${i}`);
                    const slider = hybridControl.querySelector('.hybrid-cc-slider');
                    const valueDisplay = hybridControl.querySelector('.hybrid-cc-value');

                    // Event listener para o input do número do CC
                    ccInput.addEventListener('input', (e) => {
                        let val = parseInt(e.target.value);
                        if (isNaN(val) || val < 0) val = 0;
                        if (val > 127) val = 127;
                        e.target.value = val; // Corrigir valor inválido
                        // Não envia CC aqui, apenas atualiza o número exibido
                        hybridControl.querySelector('label').textContent = `CC ${val}`;
                    });


                    slider.addEventListener('input', (e) => {
                        const ccNumber = parseInt(ccInput.value);
                        const value = parseInt(e.target.value);
                        sendControlChange(ccNumber, value); // Reutiliza a função de CC
                        valueDisplay.textContent = value;
                    });

                } else { // Últimos 8: Botões de Notas
                    const buttonIndex = i - 8; // Mapeia para 0-7 para os botões

                    hybridControl.innerHTML = `
                        <label for="hybridNote${buttonIndex}">Nota ${buttonIndex}:</label>
                        <input type="number" id="hybridNote${buttonIndex}" class="hybrid-note-input" min="0" max="127" value="${60 + buttonIndex}" disabled>
                        <button class="midi-button hybrid-note-button" data-hybrid-index="${buttonIndex}" disabled>${getNoteNameFromMIDI(60 + buttonIndex)}</button>
                    `;
                    const noteInput = hybridControl.querySelector(`#hybridNote${buttonIndex}`);
                    const button = hybridControl.querySelector('.hybrid-note-button');

                     // Event listener para o input do número da nota
                    noteInput.addEventListener('input', (e) => {
                        let val = parseInt(e.target.value);
                        if (isNaN(val) || val < 0) val = 0;
                        if (val > 127) val = 127;
                        e.target.value = val; // Corrigir valor inválido
                        button.textContent = getNoteNameFromMIDI(val); // Atualiza o texto do botão
                    });

                    // Eventos de mouse e toque para Note On/Off
                    let isHybridButtonActive = false; // Estado para gerir pressionamento do botão híbrido

                    const startHandler = (e) => {
                        e.preventDefault();
                        if (!ws || ws.readyState !== WebSocket.OPEN || isHybridButtonActive) return;
                        isHybridButtonActive = true;
                        button.classList.add('active');
                        const noteToSend = parseInt(noteInput.value);
                        sendNoteOn(null, noteToSend); // Usa noteOverride
                    };

                    const endHandler = (e) => {
                        e.preventDefault();
                        if (!ws || ws.readyState !== WebSocket.OPEN || !isHybridButtonActive) return;
                        isHybridButtonActive = false;
                        button.classList.remove('active');
                        const noteToSend = parseInt(noteInput.value);
                        sendNoteOff(null, noteToSend); // Usa noteOverride
                    };

                    button.addEventListener('mousedown', startHandler);
                    button.addEventListener('mouseup', endHandler);
                    button.addEventListener('mouseleave', endHandler); // Libera se o mouse sair
                    button.addEventListener('touchstart', startHandler);
                    button.addEventListener('touchend', endHandler);
                    button.addEventListener('touchcancel', endHandler); // Libera se o toque for cancelado
                }
                hybridGrid.appendChild(hybridControl);
            }
        }

        function enableHybridControls() {
            const controls = hybridGrid.querySelectorAll('.hybrid-control');
            controls.forEach(control => {
                control.classList.remove('disabled');
                control.querySelectorAll('input, button').forEach(el => el.disabled = false);
            });
        }

        function disableHybridControls() {
            const controls = hybridGrid.querySelectorAll('.hybrid-control');
            controls.forEach(control => {
                control.classList.add('disabled');
                control.querySelectorAll('input, button').forEach(el => el.disabled = true);
            });
        }


        // --- Funções para Gestão de Abas ---
        function openTab(tabName) {
            // Esconder todo o conteúdo das abas e remover classe 'active' dos botões de abas
            document.querySelectorAll('.tab-content').forEach(tabContent => {
                tabContent.classList.remove('active');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar a aba selecionada e ativar o botão de aba
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');

            currentActiveTab = tabName; // Atualiza a aba ativa

            // Gerir visibilidade dos campos de configuração
            baseNoteControlGroup.style.display = 'none';
            velocityControlGroup.style.display = 'none';
            ccStartControlGroup.style.display = 'none';

            // Desabilitar todos os controles de todas as abas por segurança
            disableButtons();
            disableCcSliders();
            disableHybridControls();

            // Ativar os controles da aba atual APENAS se estiver conectado
            if (tabName === 'notes') {
                baseNoteControlGroup.style.display = 'block';
                velocityControlGroup.style.display = 'block';
                if (ws && ws.readyState === WebSocket.OPEN) {
                    enableButtons();
                }
            } else if (tabName === 'ccs') {
                ccStartControlGroup.style.display = 'block';
                if (ws && ws.readyState === WebSocket.OPEN) {
                    enableCcSliders();
                }
            } else if (tabName === 'hybrid') {
                // Para a aba híbrida, os campos de nota base/velocidade não são usados
                // O canal MIDI ainda é global
                if (ws && ws.readyState === WebSocket.OPEN) {
                    enableHybridControls();
                }
            }
            // Atualiza os rótulos dos CCs se a aba CCs estiver ativa
            if (tabName === 'ccs') {
                updateCcSliderLabels();
            }
        }

        // Desabilita todos os tipos de controles (chamado ao desconectar)
        function disableAllControls() {
            disableButtons();
            disableCcSliders();
            disableHybridControls();
        }

        // --- Event Listeners ---
        connectBtn.addEventListener('click', connectWebSocket);

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                openTab(button.dataset.tab);
            });
        });

        // Prevenir context menu nos botões
        document.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('midi-button') || e.target.classList.contains('hybrid-note-button')) {
                e.preventDefault();
            }
        });

        // Release all active notes when window loses focus
        window.addEventListener('blur', () => {
            // Garante que todas as notas ativas sejam desativadas
            for (let buttonIndex of activeButtons) {
                handleButtonRelease(buttonIndex); // Libera botões da aba de Notas
            }
            // Para botões híbridos, seria necessário um Set separado ou iterar de forma diferente
            // Por simplicidade, assumimos que handleButtonRelease cuida dos Note Off corretamente
            // caso o foco seja perdido enquanto um botão híbrido está pressionado.
            // Para uma robustez máxima em produção, cada tipo de botão deveria gerir seu próprio estado 'active'
            // e chamar seu respectivo NoteOff em 'blur'.
        });

        // --- Inicialização ---
        createButtonGrid();  // Cria os botões de notas da primeira aba
        createCcSliders();   // Cria os sliders de CCs da segunda aba
        createHybridGrid();  // Cria os controles híbridos da terceira aba

        // Define o estado inicial da UI
        connectBtn.disabled = false;
        statusDiv.textContent = 'Aguardando conexão...';
        statusDiv.className = 'status disconnected';
        openTab('notes'); // Abre a aba de Notas por padrão ao carregar
    </script>
</body>
</html>
